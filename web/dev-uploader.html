<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        #uploader {
            width: 100px;
            height: 100px;
            background-color: #1ab3ff;
            display: block;
        }

        input {
            display: none;
        }
    </style>
    <script src="/js/genFuncLib.js"></script>
</head>
<body>
<label id="uploader">

    <input type="file" multiple>
</label>
<ul id="files"></ul>
<script>
    showUploader = function (data) {
        this.data     = Object.assign(
            {
                targetLabel    : null,  //展示用的目标label
                targetInput    : null,  //目标input
                countLimit     : 100,   //文件数量上限
                sizeLimit      : 1024 * 1024 * 1024,//文件尺寸上限
                chunkSize      : 1024 * 1024 * 5,  //大于xx后分割文件上传,0不分割
                //更新文件列表的函数
                refreshFileList: () => {
                    let targetStr = '';
                    for (let i1 = 0; i1 < this.public.fileList.length; i1++) {
                        let cur = this.public.fileList[i1];
                        targetStr += `<li>${cur.name}</li>`;
                    }
                    document.getElementById('files').innerHTML = targetStr;
                },
                // upload processor -----------------
                /**
                 * send .part
                 *      receive partial token
                 * send .part + token
                 * send .part + token
                 * send .part + token
                 * send .end
                 * end
                 * */
                uploadUrl      : '/upload/receive',
                partSignal     : '__PART__',
                endSignal      : '__END__',
                extraData      : {},//附加的额外数据
                uploadOneTime  : 5,
                //上传时的 onprogress 事件
                uploadProgress : (e, fileList) => {
                    console.info('on process');
                    console.info(e);
                    console.info(fileList);
                },
                uploadStatus   : {
                    uploading: false,
                    useChunk : false,
                    totalFile: 0,
                },
                tokenSize      : 16,
                onComplete     : () => {
                    console.info('complete');
                }
                //
            }, data);
        //内部数据
        this.internal = {
            // default event -----------------
            preventEventList: [
                'drag',
                'dragleave',
                'dragenter',
                'dragover',
                'drop'
            ],
            preventEvent    : (e) => {
                e.preventDefault();
                e.stopPropagation();
            },
            callPrevent     : () => {
                for (let ia = 0; ia < this.internal.preventEventList.length; ia++) {
                    console.debug('has prevent event:' + this.internal.preventEventList[ia]);
                    document.addEventListener(
                        this.internal.preventEventList[ia], this.internal.preventEvent)
                }
            },
            removePrevent   : () => {
                for (let ia = 0; ia < this.internal.preventEventList.length; ia++) {
                    console.debug('has prevent event:' + this.internal.preventEventList[ia]);
                    document.removeEventListener(
                        this.internal.preventEventList[ia], this.internal.preventEvent)
                }
            },
            // file uploader -----------------
            uploadFileQueue : [],
            fillQueue       : () => {
                //写入队列
                for (let i1 = 0; i1 < this.public.fileList.length; i1++) {
                    // console.info('here');
                    let current = this.public.fileList[i1];
                    console.info(current);
                    if (!this.data.chunkSize || current.size < this.data.chunkSize) {
                        //文件长度不大或者不需要拆分，就不拆分
                        console.info('no chunk');
                        this.internal.uploadFileQueue.push({relFileList: this.public.fileList[i1], relFileIndex: i1, file: current});
                    } else {
                        //如果需要拆分的话，在文件名上写入拆分标志+token
                        let chunkSize = Math.ceil(current.size / this.data.chunkSize);
                        console.info(`chunk ${chunkSize}`);
                        //
                        $token = genFunc.randStr(this.data.tokenSize);
                        //
                        for (let i2 = 0; i2 < chunkSize; i2++) {
                            let subFileData = current.slice(
                                i2 * this.data.chunkSize,
                                (i2 + 1) * this.data.chunkSize,
                            );
                            //
                            let fName       = current.name;
                            if (i2 < chunkSize - 1) fName += this.data.partSignal + $token;
                            else fName += this.data.endSignal + $token;
                            //
                            let subFile = new File([subFileData], fName);
                            this.internal.uploadFileQueue.push({relFileList: this.public.fileList[i1], relFileIndex: i1, file: subFile});
                        }
                    }
                }
            },
            uploadWalker    : () => {
                // console.info('here');
                let fileList     = {};
                let fileInfoList = {};
                for (let i1 = 0; i1 < this.data.uploadOneTime || i1 < 1; i1++) {
                    // console.info('here');
                    let index = '0000000' + i1;
                    index     = index.substr(-7);
                    let cur   = this.internal.uploadFileQueue.shift();
                    if (!cur) break;
                    fileList['upd_file_' + index]     = cur.file;
                    fileInfoList['upd_file_' + index] = {relFileList: cur.relFileList, relFileIndex: cur.relFileIndex};
                }
                let query = new Promise((resolve, reject) => {
                    let xhr = genFunc.sendAjaxV3(
                        {
                            path            : this.data.uploadUrl,
                            post            : Object.assign(this.data.extraData, fileList),
                            success         : (result, status) => {
                                return resolve(result, status);
                            },
                            error           : (result, status) => {
                                return reject(result, status);
                            },
                            onUploadProgress: (e) => {
                                if (!this.data.uploadProgress) return;
                                this.data.uploadProgress(e, fileInfoList);
                            },
                        });
                });
                query.then((result, status) => {
                    console.info(result);
                    // console.info(status);
                    if (!this.internal.uploadFileQueue.length) {
                        if (this.data.onComplete) return this.data.onComplete();
                        return;
                    }
                    this.internal.uploadWalker();
                }).catch((result, status) => {
                    console.warn(result);
                    console.info(status);
                });
            },
        };
        //类型
        this.public   = {
            fileList : [],    //文件列表 [File]
            // file processor -----------------
            addFile  : (file) => {
                //之前的文件列表长度
                let preLength = this.public.fileList.length;
                //如果导入的是一个数组，遍历，如果是文件，做成数组去遍历
                if (file.length === undefined) file = [file];
                for (let i1 = 0; i1 < file.length; i1++) {
                    this.public.checkFile(file[i1])
                        .then(() => {
                            this.public.fileList.push(file[i1]);
                            this.data.refreshFileList();
                        })
                        .catch((info) => {console.error(info)});
                }
                //这里因为用了异步函数，所以下面的步骤全没有用了
                // if (preLength === this.public.fileList.length) return false;
                // this.data.refreshFileList();
                return true;
            },
            checkFile: (file) => {
                /**
                 * @see https://segmentfault.com/a/1190000013298317
                 * */
                return new Promise((resolve, reject) => {
                    // console.info(file);
                    if (file.type) { return resolve();}
                    if (!file.size) { return reject('empty file not allowed'); }
                    try {
                        let fileReader = new FileReader();
                        fileReader.addEventListener('load', function (e) {
                            resolve();
                        }, false);

                        fileReader.addEventListener('error', function (e) {
                            reject('file unreadable');
                        }, false);
                        fileReader.readAsDataURL(file.slice(0, 16));
                    } catch (e) {
                        return reject(`error:${e.toString()}`);
                    }
                });
            },
            delFile  : (fileIndex) => {
                let preLength = this.public.fileList.length;
                //
                this.public.fileList.splice(fileIndex, 1);
                //
                if (preLength === this.public.fileList.length) return false;
                this.data.refreshFileList();
                return true;
            },
            // file uploader -----------------
            upload   : () => {
                this.internal.fillQueue();
                this.internal.uploadWalker();
            },
        };
        if (!this.data.targetLabel) {
            console.info('no login token');
            return false;
        }
        this.internal.callPrevent();
        // this.internal.removePrevent();
        //
        this.data.targetLabel.addEventListener('dragenter', (e) => {
            // console.debug('dragenter');
            // console.debug(e);
        });
        this.data.targetLabel.addEventListener('dragleave', (e) => {
            // console.debug('dragleave');
            // console.debug(e);
        });
        this.data.targetLabel.addEventListener('drop', (e) => {
            console.debug('drop');
            // console.debug(e);
            // console.debug(e.dataTransfer.files);
            //话说不清楚这个是否会存在到别的数据。。。
            this.public.addFile(e.dataTransfer.files);
        });
        this.data.targetLabel.addEventListener('paste', (e) => {
            console.debug('paste');
            // console.debug(e);
            // console.debug(e.clipboardData.files);
            this.public.addFile(e.clipboardData.files);
        });
    };

    // ---------------------------------------------
    // ---------------------------------------------
    // ---------------------------------------------

    let t = new showUploader(
        {
            targetLabel: document.getElementById('uploader'),
            targetInput: document.querySelector('#uploader input[type="file"]'),
        });


</script>
</body>
</html>